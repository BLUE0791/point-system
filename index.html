<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>积分奖励系统</title>
    <!-- 缓存控制头：防止浏览器缓存旧版本代码 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 添加版本控制 -->
    <script>
        // 版本控制代码 - 每次更新时修改这个版本号
        const APP_VERSION = "1.0.2";
        const savedVersion = localStorage.getItem('appVersion');
        
        if (savedVersion !== APP_VERSION) {
            localStorage.clear();  // 清除旧数据
            localStorage.setItem('appVersion', APP_VERSION);
            location.reload(true); // 强制刷新页面
        }
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6FC0DE',
                        secondary: '#F6CC5E',
                        success: '#45CFF9',
                        danger: '#FFC848',
                        warning: '#FFE418',
                        info: '#4FC1E9',
                        dark: '#3A3F51',
                        light: '#F5F7FA'
                    },
                    fontFamily: {
                        sans: ['Noto Sans SC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans SC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e7f1 100%);
            min-height: 100vh;
            padding-bottom: 40px;
            touch-action: manipulation;
            font-size: 16px;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.12);
        }
        
        .btn {
            transition: all 0.2s ease;
            border-radius: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            min-height: 44px;
            user-select: none;
            padding: 0.5rem 1rem;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background: linear-gradient(to right, #6FC0DE, #5D9CEC);
            color: white;
            border: none;
        }
        
        .btn-secondary {
            background: linear-gradient(to right, #F6CC5E, #FFCE54);
            color: white;
            border: none;
        }
        
        .btn-success {
            background: linear-gradient(to right, #45CFF9, #48CFAD);
            color: white;
            border: none;
        }
        
        .btn-danger {
            background: linear-gradient(to right, #FFC848, #FC6E51);
            color: white;
            border: none;
        }
        
        .btn-warning {
            background: linear-gradient(to right, #FFE418, #FFA9A3);
            color: white;
            border: none;
        }
        
        .fade-in {
            animation: fadeIn 0.4s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .progress-bar {
            height: 10px;
            border-radius: 5px;
            background-color: #e0e0e0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 5px;
            background: linear-gradient(to right, #45CFF9, #48CFAD);
            transition: width 0.5s ease;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            touch-action: none;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: modalIn 0.3s ease-out;
        }
        
        @keyframes modalIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-button {
            padding: 12px 24px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
            min-height: 44px;
            user-select: none;
        }
        
        .tab-button.active {
            border-bottom-color: #6FC0DE;
            color: #6FC0DE;
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #3A3F51;
            color: white;
            padding: 14px 24px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 2000;
            min-height: 44px;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .currency-tag {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .currency-cny {
            background: #4FC1E9;
            color: white;
        }
        
        .currency-mop {
            background: #A0D468;
            color: white;
        }
        
        .record-item {
            border-left: 4px solid #6FC0DE;
            padding: 12px 15px;
            margin-bottom: 10px;
            background: #f8f9ff;
            border-radius: 0 8px 8px 0;
        }
        
        .event-point-btn {
            padding: 8px 16px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
            user-select: none;
        }
        
        .event-point-btn.active {
            background: #6FC0DE;
            color: white;
            border-color: #6FC0DE;
        }
        
        /* 移动端优化 */
        button, .btn, .event-point-btn, .close-modal, 
        .apply-event-btn, .delete-btn, .redeem-btn,
        .add-record-btn, .view-records-btn, .tab-button {
            touch-action: manipulation;
        }
        
        input, select, textarea {
            font-size: 1rem;
            padding: 0.5rem;
        }
        
        /* 修复移动端点击延迟 */
        html {
            touch-action: manipulation;
        }
    </style>
</head>
<body>
    <div class="min-h-screen">
        <!-- 顶部导航栏 -->
        <header class="bg-gradient-to-r from-primary to-info text-white shadow-lg py-5">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold flex items-center">
                        <i class="fa fa-star mr-2"></i> 积分奖励系统
                    </h1>
                    <div class="flex items-center">
                        <div class="mr-6 text-center">
                            <div class="text-sm">总积分</div>
                            <div class="text-2xl font-bold" id="totalPoints">0</div>
                        </div>
                        <div class="text-center">
                            <div class="text-sm">总攒钱金额</div>
                            <div class="text-2xl font-bold" id="totalSavings">0.00 <span class="text-sm">¥</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- 主内容区 -->
        <main class="container mx-auto px-4 py-6">
            <!-- 选项卡导航（始终横排） -->
            <div class="flex bg-white rounded-xl mb-6 shadow-sm">
                <button id="eventsTabBtn" class="tab-button flex-1 active">事件</button>
                <button id="rewardsTabBtn" class="tab-button flex-1">奖励</button>
                <button id="savingsTabBtn" class="tab-button flex-1">攒钱</button>
            </div>

            <!-- 事件列表 -->
            <div id="eventsTab" class="py-4">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-700">我的事件</h2>
                    <button id="addEventBtn" class="btn btn-primary px-5 py-2.5">
                        <i class="fa fa-plus mr-2"></i> 添加事件
                    </button>
                </div>
                
                <!-- 事件分类标签 -->
                <div class="flex space-x-3 mb-6">
                    <button id="plusEventsBtn" class="btn btn-success px-5 py-2 flex-1">加分事件</button>
                    <button id="minusEventsBtn" class="btn btn-danger px-5 py-2 flex-1">扣分事件</button>
                </div>
                
                <!-- 事件列表容器 - 确保始终单列 -->
                <div id="eventsContainer" class="grid grid-cols-1 gap-4">
                    <!-- 事件卡片会动态生成在这里 -->
                    <div class="card p-5 text-center">
                        <i class="fa fa-calendar-plus-o text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">暂无事件，点击"添加事件"按钮创建</p>
                    </div>
                </div>
            </div>

            <!-- 奖励列表 (默认隐藏) -->
            <div id="rewardsTab" class="py-4 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-700">我的奖励</h2>
                    <button id="addRewardBtn" class="btn btn-secondary px-5 py-2.5">
                        <i class="fa fa-gift mr-2"></i> 添加奖励
                    </button>
                </div>
                
                <!-- 奖励列表容器 - 确保始终单列 -->
                <div id="rewardsContainer" class="grid grid-cols-1 gap-4">
                    <!-- 奖励卡片会动态生成在这里 -->
                    <div class="card p-5 text-center">
                        <i class="fa fa-gift text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">暂无奖励，点击"添加奖励"按钮创建</p>
                    </div>
                </div>
            </div>

            <!-- 攒钱列表 (默认隐藏) -->
            <div id="savingsTab" class="py-4 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-700">我的攒钱计划</h2>
                    <button id="addSavingBtn" class="btn btn-warning px-5 py-2.5">
                        <i class="fa fa-piggy-bank mr-2"></i> 添加攒钱项
                    </button>
                </div>
                
                <!-- 总攒钱金额显示 -->
                <div class="bg-white rounded-xl p-4 mb-6 shadow-md">
                    <div class="flex items-center justify-between">
                        <h3 class="font-bold text-lg">总攒钱金额</h3>
                        <div class="flex items-center">
                            <i class="fa fa-money text-warning mr-2"></i>
                            <span id="totalSavings" class="text-2xl font-bold">0.00</span>
                            <span class="ml-1">¥</span>
                        </div>
                    </div>
                </div>
                
                <!-- 攒钱列表容器 - 确保始终单列 -->
                <div id="savingsContainer" class="grid grid-cols-1 gap-4">
                    <!-- 攒钱卡片会动态生成在这里 -->
                    <div class="card p-5 text-center">
                        <i class="fa fa-money text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">暂无攒钱计划，点击"添加攒钱项"按钮创建</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 模态框 -->
    <div id="addEventModal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">添加新事件</h3>
                    <button class="text-gray-500 hover:text-gray-700 close-modal">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                
                <form id="addEventForm">
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">事件名称</label>
                        <input type="text" id="eventName" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="例如：晨跑" required>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">事件类型</label>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="eventType" value="plus" checked class="mr-2">
                                <span class="text-success font-medium">加分事件</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="eventType" value="minus" class="mr-2">
                                <span class="text-danger font-medium">扣分事件</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 mb-2">积分值</label>
                        <div class="flex space-x-3">
                            <button type="button" class="event-point-btn flex-1 active" data-points="1">1分</button>
                            <button type="button" class="event-point-btn flex-1" data-points="2">2分</button>
                            <button type="button" class="event-point-btn flex-1" data-points="3">3分</button>
                        </div>
                        <input type="hidden" id="eventPoints" value="1">
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" class="btn bg-gray-200 text-gray-700 px-5 py-2.5 close-modal">取消</button>
                        <button type="submit" class="btn btn-primary px-5 py-2.5">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 添加奖励模态框 -->
    <div id="addRewardModal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">添加新奖励</h3>
                    <button class="text-gray-500 hover:text-gray-700 close-modal">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                
                <form id="addRewardForm">
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">奖励名称</label>
                        <input type="text" id="rewardName" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-secondary focus:border-transparent" placeholder="例如：看电影" required>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">所需积分</label>
                        <input type="number" id="rewardPoints" min="1" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-secondary focus:border-transparent" placeholder="例如：50" required>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 mb-2">奖励描述</label>
                        <textarea id="rewardDescription" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-secondary focus:border-transparent" placeholder="描述这个奖励..."></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" class="btn bg-gray-200 text-gray-700 px-5 py-2.5 close-modal">取消</button>
                        <button type="submit" class="btn btn-secondary px-5 py-2.5">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 添加攒钱项模态框 -->
    <div id="addSavingModal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">添加攒钱项</h3>
                    <button class="text-gray-500 hover:text-gray-700 close-modal">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                
                <form id="addSavingForm">
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">攒钱项目</label>
                        <input type="text" id="savingName" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-warning focus:border-transparent" placeholder="例如：买新手机" required>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">目标金额</label>
                        <div class="flex space-x-3">
                            <input type="number" id="savingTarget" min="0.01" step="0.01" class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-warning focus:border-transparent" placeholder="例如：5000.00" required>
                            <select id="savingCurrency" class="px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-warning focus:border-transparent">
                                <option value="CNY">人民币 (¥)</option>
                                <option value="MOP">澳门币 (MOP)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" class="btn bg-gray-200 text-gray-700 px-5 py-2.5 close-modal">取消</button>
                        <button type="submit" class="btn btn-warning px-5 py-2.5">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 添加攒钱记录模态框 -->
    <div id="addSavingRecordModal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800" id="savingRecordTitle">添加攒钱记录</h极>
                    <button class="text-gray-500 hover:text-gray-700 close-modal">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                
                <form id="addSavingRecordForm">
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">攒钱金额</label>
                        <input type="number" id="recordAmount" min="0.01" step="0.01" class="w-full px-4 py极3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-warning focus:border-transparent" placeholder="例如：200.00" required>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">货币类型</label>
                        <select id="recordCurrency" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-warning focus:border-transparent">
                            <option value="CNY">人民币 (¥)</option>
                            <option value="MOP">澳门币 (MOP)</option>
                        </select>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 mb-2">备注（可选）</label>
                        <input type="text" id="recordNote" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-warning focus:border-transparent" placeholder="例如：3月工资">
                    </div>
                    
                    <input type="hidden" id="currentSavingId" value="">
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" class="btn bg-gray-200 text-gray-700 px-5 py-2.5 close-modal">取消</button>
                        <button type="submit" class="btn btn-warning px-5 py-2.5">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 查看攒钱记录模态框 -->
    <div id="viewSavingRecordsModal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800" id="savingRecordsTitle">攒钱记录</h3>
                    <button class="text-gray-500 hover:text-gray-700 close-modal">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                
                <div id="savingRecordsContainer" class="mb-6">
                    <!-- 记录会动态生成在这里 -->
                </div>
                
                <div class="flex justify-end">
                    <button type="button" id="addNewRecordBtn" class="btn btn-warning px-5 py-2.5">
                        添加新记录
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mb-4">
                        <i class="fa fa-trash text-red-500 text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold" id="deleteModalTitle">删除事件</h3>
                    <p class="text-gray-700 mt-2" id="deleteModalMessage">确定要删除这个事件吗？</p>
                </div>
                
                <div class="flex justify-center space-x-3">
                    <button type="button" class="btn bg-gray-200 text-gray-700 px-6 py-3 close-modal">取消</button>
                    <button type="button" class="btn btn-danger px-6 py-3" id="confirmDeleteBtn">删除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 操作提示 -->
    <div id="toast" class="toast">
        <i id="toastIcon" class="fa fa-check-circle mr-2"></i>
        <span id="toastMessage"></span>
    </div>

    <script>
        // 数据模型
        let appData = {
            totalPoints: 0,
            totalSavings: 0,
            events: [],
            rewards: [],
            savings: []
        };
        
        // 当前要删除的项目ID和类型
        let currentDeleteId = null;
        let currentDeleteType = null;
        
        // 当前查看/编辑的攒钱项目ID
        let currentSavingId = null;
        
        // 货币汇率（1 MOP = 0.88 CNY）
        const EXCHANGE_RATE = 0.88;
        
        // 初始化应用
        function initApp() {
            // 加载本地存储的数据
            loadData();
            
            // 兼容处理：确保旧数据结构正确
            appData.events.forEach(event => {
                if (!event.hasOwnProperty('createdAt')) {
                    event.createdAt = new Date().toISOString();
                }
            });
            
            // 渲染界面
            renderEvents('plus');
            renderRewards();
            renderSavings();
            updatePointsDisplay();
            updateSavingsDisplay();
            
            // 绑定事件监听器
            bindEventListeners();
            
            // 绑定动态元素的事件
            setupDynamicEventHandlers();
        }
        
        // 从本地存储加载数据
        function loadData() {
            const savedData = localStorage.getItem('pointSystemData');
            if (savedData) {
                try {
                    appData = JSON.parse(savedData);
                } catch (e) {
                    console.error('解析本地存储数据失败', e);
                    appData = {
                        totalPoints: 0,
                        totalSavings: 0,
                        events: [],
                        rewards: [],
                        savings: []
                    };
                }
            } else {
                appData = {
                    totalPoints: 0,
                    totalSavings: 0,
                    events: [],
                    rewards: [],
                    savings: []
                };
            }
        }
        
        // 保存数据到本地存储
        function saveData() {
            localStorage.setItem('pointSystemData', JSON.stringify(appData));
        }
        
        // 更新积分显示
        function updatePointsDisplay() {
            document.getElementById('totalPoints').textContent = appData.totalPoints;
        }
        
        // 更新攒钱显示
        function updateSavingsDisplay() {
            // 计算所有攒钱记录的总金额（换算为人民币）
            let total = 0;
            appData.savings.forEach(saving => {
                saving.records.forEach(record => {
                    if (record.currency === 'MOP') {
                        total += record.amount * EXCHANGE_RATE;
                    } else {
                        total += record.amount;
                    }
                });
            });
            
            appData.totalSavings = total;
            document.getElementById('totalSavings').textContent = total.toFixed(2);
            saveData();
        }
        
        // 渲染事件列表
        function renderEvents(filterType = 'plus') {
            const eventsContainer = document.getElementById('eventsContainer');
            eventsContainer.innerHTML = '';
            
            // 根据筛选类型过滤事件
            let filteredEvents = appData.events.filter(e => 
                filterType === 'plus' ? e.points > 0 : e.points < 0
            );
            
            if (filteredEvents.length === 0) {
                eventsContainer.innerHTML = `
                    <div class="card p-5 text-center">
                        <i class="fa fa-calendar-plus-o text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">还没有${filterType === 'plus' ? '加分' : '扣分'}事件</p>
                    </div>
                `;
                return;
            }
            
            filteredEvents.forEach(event => {
                const isPositive = event.points > 0;
                const pointColorClass = isPositive ? 'bg-success' : 'bg-danger';
                const pointIcon = isPositive ? 'fa-plus-circle' : 'fa-minus-circle';
                const actionText = isPositive ? '完成事件' : '扣除积分';
                
                const eventCard = document.createElement('div');
                eventCard.className = 'card fade-in';
                eventCard.innerHTML = `
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="font-bold text-lg text-gray-800">${event.name}</h3>
                            <span class="${pointColorClass} text-white px-3 py-1 rounded-full text-sm flex items-center">
                                <i class="fa ${pointIcon} mr-1"></i> ${isPositive ? '+' : ''}${event.points}
                            </span>
                        </div>
                        <div class="flex space-x-3 mt-4">
                            <button class="apply-event-btn flex-1 py-2.5 btn ${isPositive ? 'btn-success' : 'btn-danger'} rounded-xl" data-id="${event.id}">
                                ${actionText}
                            </button>
                            <button class="delete-btn w-12 py-2.5 bg-gray-100 hover:bg-danger hover:text-white rounded-xl" data-type="event" data-id="${event.id}">
                                <i class="fa fa-trash"></i>
                            </button>
                        </极>
                    </div>
                `;
                
                eventsContainer.appendChild(eventCard);
            });
        }
        
        // 渲染奖励列表
        function renderRewards() {
            const rewardsContainer = document.getElementById('rewardsContainer');
            rewardsContainer.innerHTML = '';
            
            if (appData.rewards.length === 0) {
                rewardsContainer.innerHTML = `
                    <div class="card p-5 text-center">
                        <i class="fa fa-gift text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">还没有奖励</p>
                    </div>
                `;
                return;
            }
            
            appData.rewards.forEach(reward => {
                const canRedeem = appData.totalPoints >= reward.points;
                const redeemBtnClass = canRedeem ? 'btn-secondary' : 'bg-gray-300 cursor-not-allowed';
                
                const rewardCard = document.createElement('div');
                rewardCard.className = 'card fade-in';
                rewardCard.innerHTML = `
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="font-bold text-lg text-gray-800">${reward.name}</h3>
                            <span class="bg-yellow-400 text-white px-3 py-1 rounded-full text-sm flex items-center">
                                <i class="fa fa-star mr-1"></i> ${reward.points}
                            </span>
                        </div>
                        <p class="text-gray-600 mb-4">${reward.description || '暂无描述'}</p>
                        <div class="flex space-x-3 mt-4">
                            <button class="redeem-btn flex-1 py-2.5 ${redeemBtnClass} rounded-xl" data-id="${reward.id}" ${canRedeem ? '' : 'disabled'}>
                                兑换奖励
                            </button>
                            <button class="delete-btn w-12 py-2.5 bg-gray-100 hover:bg-danger hover:text-white rounded-xl" data-type="reward" data-id="${reward.id}">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                rewardsContainer.appendChild(rewardCard);
            });
        }
        
        // 渲染攒钱列表
        function renderSavings() {
            const savingsContainer = document.getElementById('savingsContainer');
            savingsContainer.innerHTML = '';
            
            if (appData.savings.length === 0) {
                savingsContainer.innerHTML = `
                    <div class="card p-5 text-center">
                        <i class="fa fa-money text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">还没有攒钱计划</p>
                    </div>
                `;
                return;
            }
            
            appData.savings.forEach(saving => {
                // 计算已攒金额（考虑货币类型和汇率）
                let savedAmount = 0;
                saving.records.forEach(record => {
                    if (record.currency === 'MOP') {
                        savedAmount += record.amount * EXCHANGE_RATE;
                    } else {
                        savedAmount += record.amount;
                    }
                });
                
                // 计算目标金额（如果是MOP则转换为CNY显示）
                const targetAmount = saving.currency === 'MOP' 
                    ? saving.target * EXCHANGE_RATE 
                    : saving.target;
                
                // 计算进度百分比
                const progress = Math.min(100, (savedAmount / targetAmount) * 100);
                
                const savingCard = document.createElement('div');
                savingCard.className = 'card fade-in';
                savingCard.innerHTML = `
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="font-bold text-lg text-gray-800">${saving.name}</h3>
                            <span class="bg-warning text-white px-3 py-1 rounded-full text-sm flex items-center">
                                <i class="fa fa-piggy-bank mr-1"></i>
                                <span>${saving.currency === 'MOP' ? 'MOP' : '¥'}</span>
                            </span>
                        </div>
                        
                        <div class="mb-4">
                            <div class="flex justify-between mb-1 text-sm text-gray-600">
                                <span>已攒: ${savedAmount.toFixed(2)} ¥</span>
                                <span>目标: ${targetAmount.toFixed(2)} ¥</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3 mt-4">
                            <button class="add-record-btn flex-1 py-2.5 btn btn-warning rounded-xl" data-id="${saving.id}">
                                <i class="fa fa-plus mr-1"></i> 添加记录
                            </button>
                            <button class="view-records-btn w-12 py-2.5 bg-gray-100 hover:bg-primary hover:text-white rounded-xl" data-id="${saving.id}">
                                <i class="fa fa-history"></i>
                            </button>
                            <button class="delete-btn w-12 py-2.5 bg-gray-100 hover:bg-danger hover:text-white rounded-xl" data-type="saving" data-id="${saving.id}">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                savingsContainer.appendChild(savingCard);
            });
        }
        
        // 渲染攒钱记录
        function renderSavingRecords(savingId) {
            const savingRecordsContainer = document.getElementById('savingRecordsContainer');
            savingRecordsContainer.innerHTML = '';
            
            const saving = appData.savings.find(s => s.id === savingId);
            if (!saving) return;
            
            document.getElementById('savingRecordsTitle').textContent = saving.name + ' - 攒钱记录';
            
            if (saving.records.length === 0) {
                savingRecordsContainer.innerHTML = `
                    <div class="card p-5 text-center">
                        <i class="fa fa-inbox text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">还没有攒钱记录</p>
                    </div>
                `;
                return;
            }
            
            saving.records.forEach(record => {
                // 计算人民币价值
                const cnyValue = record.currency === 'MOP' 
                    ? record.amount * EXCHANGE_RATE 
                    : record.amount;
                
                const recordDate = new Date(record.date);
                const formattedDate = `${recordDate.getFullYear()}-${(recordDate.getMonth()+1).toString().padStart(2, '0')}-${recordDate.getDate().toString().padStart(2, '0')} ${recordDate.getHours().toString().padStart(2, '0')}:${recordDate.getMinutes().toString().padStart(2, '0')}`;
                
                const recordEl = document.createElement('div');
                recordEl.className = 'record-item';
                recordEl.innerHTML = `
                    <div class="flex justify-between">
                        <div>
                            <div class="font-medium">${record.note || '无备注'}</div>
                            <div class="text-sm text-gray-500">${formattedDate}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold">${record.amount.toFixed(2)} 
                                <span class="currency-tag ${record.currency === 'MOP' ? 'currency-mop' : 'currency-cny'}">
                                    ${record.currency === 'MOP' ? 'MOP' : '¥'}
                                </span>
                            </div>
                            <div class="text-sm text-gray-500">≈ ${cnyValue.toFixed(2)} ¥</div>
                        </div>
                    </div>
                `;
                
                savingRecordsContainer.appendChild(recordEl);
            });
        }
        
        // 显示通知
        function showToast(message, isSuccess = true) {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toastIcon.className = isSuccess 
                ? 'fa fa-check-circle mr-2' 
                : 'fa fa-exclamation-circle mr-2';
            toast.style.backgroundColor = isSuccess ? '#3A3F51' : '#d32f2f';
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // 绑定事件监听器
        function bindEventListeners() {
            // 关闭所有模态框
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });
            
            // 选项卡切换
            document.getElementById('eventsTabBtn').addEventListener('click', () => {
                showTab('eventsTab');
                renderEvents('plus');
            });
            
            document.getElementById('rewardsTabBtn').addEventListener('click', () => {
                showTab('rewardsTab');
                renderRewards();
            });
            
            document.getElementById('savingsTabBtn').addEventListener('click', () => {
                showTab('savingsTab');
                renderSavings();
            });
            
            // 事件分类筛选
            document.getElementById('plusEventsBtn').addEventListener('click', () => {
                renderEvents('plus');
            });
            
            document.getElementById('minusEventsBtn').addEventListener('click', () => {
                renderEvents('minus');
            });
            
            // 添加事件按钮
            document.getElementById('addEventBtn').addEventListener('click', () => {
                showModal('addEventModal');
            });
            
            // 添加奖励按钮
            document.getElementById('addRewardBtn').addEventListener('click', () => {
                showModal('addRewardModal');
            });
            
            // 添加攒钱项按钮
            document.getElementById('addSavingBtn').addEventListener('click', () => {
                showModal('addSavingModal');
            });
            
            // 积分按钮选择
            document.querySelectorAll('.event-point-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.event-point-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    btn.classList.add('active');
                    document.getElementById('eventPoints').value = btn.dataset.points;
                });
            });
            
            // 表单提交
            document.getElementById('addEventForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const name = document.getElementById('eventName').value.trim();
                const type = document.querySelector('input[name="eventType"]:checked').value;
                const points = parseInt(document.getElementById('eventPoints').value) * (type === 'plus' ? 1 : -1);
                
                if (!name) {
                    showToast('事件名称不能为空', false);
                    return;
                }
                
                appData.events.push({
                    id: Date.now().toString(),
                    name,
                    points
                });
                
                saveData();
                renderEvents(type === 'plus' ? 'plus' : 'minus');
                document.getElementById('addEventModal').style.display = 'none';
                showToast('事件添加成功');
            });
            
            document.getElementById('addRewardForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const name = document.getElementById('rewardName').value.trim();
                const points = parseInt(document.getElementById('rewardPoints').value);
                const description = document.getElementById('rewardDescription').value.trim();
                
                if (!name) {
                    showToast('奖励名称不能为空', false);
                    return;
                }
                
                if (points < 1) {
                    showToast('所需积分必须大于0', false);
                    return;
                }
                
                appData.rewards.push({
                    id极 Date.now().toString(),
                    name,
                    points,
                    description
                });
                
                saveData();
                renderRewards();
                document.getElementById('addRewardModal').style.display = 'none';
                showToast('奖励添加成功');
            });
            
            document.getElementById('addSavingForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const name = document.getElementById('savingName').value.trim();
                const target = parseFloat(document.getElementById('savingTarget').value);
                const currency = document.getElementById('savingCurrency').value;
                
                if (!name) {
                    showToast('项目名称不能为空', false);
                    return;
                }
                
                if (isNaN(target) || target <= 0) {
                    showToast('目标金额必须大于0', false);
                    return;
                }
                
                appData.savings.push({
                    id: Date.now().toString(),
                    name,
                    target,
                    currency,
                    records: []
                });
                
                saveData();
                renderSavings();
                updateSavingsDisplay();
                document.getElementById('addSavingModal').style.display = 'none';
                showToast('攒钱项目添加成功');
            });
            
            document.getElementById('addSavingRecordForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const savingId = document.getElementById('currentSavingId').value;
                const amount = parseFloat(document.getElementById('recordAmount').value);
                const currency = document.getElementById('recordCurrency').value;
                const note = document.getElementById('recordNote').value.trim();
                
                if (isNaN(amount) || amount <= 0) {
                    showToast('金额必须大于0', false);
                    return;
                }
                
                const saving = appData.savings.find(s => s.id === savingId);
                if (saving) {
                    saving.records.push({
                        id: Date.now().toString(),
                        date: new Date().toISOString(),
                        amount,
                        currency,
                        note
                    });
                    
                    saveData();
                    updateSavingsDisplay();
                    renderSavings();
                    document.getElementById('addSavingRecordModal').style.display = 'none';
                    showToast('攒钱记录添加成功');
                    
                    // 如果是从记录查看模态框添加的，刷新记录显示
                    if (document.getElementById('viewSavingRecordsModal').style.display === 'flex') {
                        renderSavingRecords(savingId);
                    }
                    
                    // 重置表单
                    document.getElementById('recordAmount').value = '';
                    document.getElementById('recordNote').value = '';
                }
            });
            
            // 确认删除
            document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                if (currentDeleteId && currentDeleteType) {
                    if (currentDeleteType === 'event') {
                        appData.events = appData.events.filter(e => e.id !== currentDeleteId);
                        renderEvents();
                    } else if (currentDeleteType === 'reward') {
                        appData.rewards = appData.rewards.filter(r => r.id !== currentDeleteId);
                        renderRewards();
                    } else if (currentDeleteType === 'saving') {
                        appData.savings = appData.savings.filter(s => s.id !== currentDeleteId);
                        renderSavings();
                        updateSavingsDisplay();
                    }
                    
                    saveData();
                    showToast('删除成功');
                    document.getElementById('deleteModal').style.display = 'none';
                    
                    // 重置删除状态
                    currentDeleteId = null;
                    currentDeleteType = null;
                }
            });
            
            // 添加新记录按钮（在记录查看模态框中）
            document.getElementById('addNewRecordBtn').addEventListener('click', () => {
                const saving = appData.savings.find(s => s.id === currentSavingId);
                if (saving) {
                    document.getElementById('savingRecordTitle').textContent = `添加记录 - ${saving.name}`;
                    document.getElementById('currentSavingId').value = currentSavingId;
                    document.getElementById('viewSavingRecordsModal').style.display = 'none';
                    document.getElementById('addSavingRecordModal').style.display = 'flex';
                }
            });
        }
        
        // 为动态生成的元素绑定事件
        function setupDynamicEventHandlers() {
            document.body.addEventListener('pointerdown', function(e) {
                // 应用事件
                if (e.target.closest('.apply-event-btn')) {
                    const btn = e.target.closest('.apply-event-btn');
                    const eventId = btn.dataset.id;
                    const event = appData.events.find(ev => ev.id === eventId);
                    if (event) {
                        appData.totalPoints += event.points;
                        updatePointsDisplay();
                        saveData();
                        showToast(`成功${event.points > 0 ? '获得' : '扣除'} ${Math.abs(event.points)} 积分`);
                    }
                    return;
                }
                
                // 删除按钮
                if (e.target.closest('.delete-btn')) {
                    const btn = e.target.closest('.delete-btn');
                    const id = btn.dataset.id;
                    const type = btn.dataset.type;
                    
                    currentDeleteId = id;
                    currentDeleteType = type;
                    
                    let title = '';
                    let message = '';
                    
                    if (type === 'event') {
                        const event = appData.events.find(e => e.id === id);
                        title = '删除事件';
                        message = `确定要删除事件 "${event.name}" 吗？`;
                    } else if (type === 'reward') {
                        const reward = appData.rewards.find(r => r.id === id);
                        title = '删除奖励';
                        message = `确定要删除奖励 "${reward.name}" 吗？`;
                    } else if (type === 'saving') {
                        const saving = appData.savings.find(s => s.id === id);
                        title = '删除攒钱项目';
                        message = `确定要删除攒钱项目 "${saving.name}" 吗？`;
                    }
                    
                    document.getElementById('deleteModalTitle').textContent = title;
                    document.getElementById('deleteModalMessage').textContent = message;
                    document.getElementById('deleteModal').style.display = 'flex';
                    return;
                }
                
                // 兑换奖励
                if (e.target.closest('.redeem-btn')) {
                    const btn = e.target.closest('.redeem-btn');
                    const rewardId = btn.dataset.id;
                    const reward = appData.rewards.find(r => r.id === rewardId);
                    if (reward && appData.totalPoints >= reward.points) {
                        appData.totalPoints -= reward.points;
                        updatePointsDisplay();
                        saveData();
                        showToast(`成功兑换 "${reward.name}"`);
                    }
                    return;
                }
                
                // 添加攒钱记录
                if (e.target.closest('.add-record-btn')) {
                    const btn = e.target.closest('.add-record-btn');
                    const savingId = btn.dataset.id;
                    currentSavingId = savingId;
                    document.getElementById('currentSavingId').value = savingId;
                    
                    const saving = appData.savings.find(s => s.id === savingId);
                    if (saving) {
                        document.getElementById('savingRecordTitle').textContent = `添加记录 - ${saving.name}`;
                        document.getElementById('addSavingRecordModal').style.display = 'flex';
                    }
                    return;
                }
                
                // 查看攒钱记录
                if (e.target.closest('.view-records-btn')) {
                    const btn = e.target.closest('.view-records-btn');
                    const savingId = btn.dataset.id;
                    currentSavingId = savingId;
                    renderSavingRecords(savingId);
                    document.getElementById('viewSavingRecordsModal').style.display = 'flex';
                    return;
                }
            });
        }
        
        // 显示选项卡
        function showTab(tabId) {
            const tabs = ['eventsTab', 'rewardsTab', 'savingsTab'];
            tabs.forEach(tab => {
                const element = document.getElementById(tab);
                const button = document.getElementById(tab + 'Btn');
                if (tab === tabId) {
                    element.classList.remove('hidden');
                    button.classList.add('active');
                } else {
                    element.classList.add('hidden');
                    button.classList.remove('active');
                }
            });
        }
        
        // 显示模态框
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
        }
        
        // 初始化应用
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
